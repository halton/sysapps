<!DOCTYPE html>
<html>

<head>
  <title>Web Telephony API</title>
  <meta charset="UTF-8">
  <script src='https://www.w3.org/Tools/respec/respec-w3c-common'
          class='remove'></script>
  <script class="remove">
    var respecConfig = {
          specStatus:           "ED",
          shortName:            "telephony",
          publishDate:          "",
          previousPublishDate:  "",
          previousMaturity:     "",
          edDraftURI:           "http://www.w3.org/2012/sysapps/",
          // lcEnd:                "",
          crEnd:                "",
          editors: [
            { name: "José M. Cantera", company: "Telefónica",
                    companyURL: "http://www.tid.es/" },
            { name: "Eduardo Fullea", company: "Telefónica",
                    companyURL: "http://www.tid.es/" },
            { name: "Zoltan Kis", company: "Intel",
                    companyURL: "http://www.intel.com/" }
          ],
          inlineCSS:    true,
          noIDLIn:      true,
          extraCSS:     ["../ReSpec.js/css/respec.css"],
          wg:           "System Applications Working Group",
          wgURI:        "http://",
          wgPublicList: "public-sysapps",
          wgPatentURI:  "http://www.w3.org/2004/01/pp-impl/43696/status",
    };
  </script>
</head>

<!-----------------------------------------------------------------------------
Style guide to contributors:
============================
- this document uses ReSpec, see
  http://dev.w3.org/2009/dap/ReSpec.js/documentation.html
- use 80 characters wide lines, whenever possible (except long links)
- keep sections 2 empty lines apart
- put comments in front of sections, for better readability with syntax coloring
  editors
- use indentation with care: it may improve readability, but at the expense of
  line lenght
- when descriptions of attributes is short, use the <dd> elements even when
  the text also contains conformance statements (e.g. MUST, SHOULD, MAY).
  No use repeating the same information in a separate paragraph.
------------------------------------------------------------------------------>

<body>

<!------------------------------ Abstract ------------------------------------>
<section id="abstract">
  This specification defines a System Level API to manage telephony calls.
  A typical use case of the Web Telephony API is the implementation of a
  'Dialer' application.
  Multiparty call and multiple SIM cards / telephony services are supported.
  A minimal structure for call history items is also defined, but this
  specification does not include any mechanisms on how to store and retrieve
  call history.
  Interfaces specific to telephony services (SIM, network, supplementary
  services, etc) are shortly presented in an informative section, in order to
  show how they would integrate with this API, but they should be defined in
  separate specification(s).
</section>


<!----------------------- Status of this document ---------------------------->
<section id="sotd">
</section>


<!----------------------------- Introduction --------------------------------->
<section class="informative">
  <h2>Introduction</h2>
  <p>The Telephony API allows applications to manage the full lifecycle of
  telephony calls, managing call signaling and audio volume settings, but does
  not handle audio channels management, which is left to the responsibility of
  the underlying hardware and middleware implementation.</p>
  <p>An example of use is provided below:
  <pre class="example highlight">
    var telCall = navigator.telephony.dial('+1234567890');
    telCall.onstatechange = function(e) {
        if (e.target.state == 'connected')
        window.console.log('Connected!');
    }

    telCall.onerror = function(e) {
        window.console.error(e);
    }
  </pre>
</section>


<!---------------------------- Conformance ----------------------------------->
<section id="conformance">
  <p>This specification defines conformance criteria that apply to a single
  product: the <dfn id="ua">user agent</dfn> that implements the interfaces
  that it contains.
  </p>
  <p>Implementations that use ECMAScript to implement the APIs defined in
  this specification MUST implement them in a manner consistent with the
  ECMAScript Bindings defined in the Web IDL specification [[!WEBIDL]], as
  this specification uses that specification and terminology.</p>
</section>


<!----------------------------- Terminology ---------------------------------->
<section>
  <h2>Terminology</h2>
  <p>The <code>
  <a href="http://dev.w3.org/html5/spec/webappapis.html#eventhandler">
  EventHandler</a></code> interface represents a callback used for event
  handlers as defined in [[!HTML5]].</p>

  <p>The concepts <dfn>
  <a href="http://dev.w3.org/html5/spec/webappapis.html#queue-a-task">
       queue a task</a></dfn> and <dfn>
  <a href="http://dev.w3.org/html5/spec/webappapis.html#fire-a-simple-event">
  fire a simple event</a></dfn> are defined in [[!HTML5]].</p>

  <p>The terms <dfn>
  <a href="http://dev.w3.org/html5/spec/webappapis.html#event-handlers">
  event handler</a></dfn>  and <dfn>
<a href="http://dev.w3.org/html5/spec/webappapis.html#event-handler-event-type">
  event handler event types</a></dfn> are defined in [[!HTML5]].</p>

  <p>An <dfn>active call</dfn> is a Telephony Call in the
  <a href='#call-state-connected'><code>connected</code></a> state and bound to
  the media input and output devices (e.g. microphone, speaker, tone generator).
  </p>

  <p>A <dfn title="telephony service">telephony service</dfn> is an object
  exposing telephony functionality associated to a subscriber identity
  registered a with a telephony service provider. For example, in cellular
  telephony a telephony service is associated to a SIM card (subscriber identity
  module). When making a call, the identity (SIM card, associated
  to a phone number) must always be specified, either explicitly in the function
  call, or by using a default telephony service in the implementation.
  The device may receive phone calls from any active telephony service, even
  simultaneously, in which case the calls must be arbitrated either by the
  implementation in the background, or the user, by choosing which call to
  answer.
  A telephony service may use different protocols for telephony signaling and
  media (e.g. GSM, CDMA, VoLTE, etc.) with the same identity. Since call states
  may differ depending on the protocol, the telephony call objects must contain
  information which identifies the service and the protocol used for making the
  call.</p>

  <p>A <dfn title="telephony service id">telephony service id</dfn> uniquely
  identifies a <a>telephony service</a> in the system.</p>

  <p>A <dfn title="active telephony service">active telephony service</dfn> is
  the <a>telephony service</a> which is set as default for telephony operations
  by the implementation. If no telephony service is specified in the methods of
  this interface, implementations MUST use the active telephony service.</p>
</section>


<!------------------------ Security and privacy ------------------------------>
<section>
  <h2>Security and privacy considerations</h2>
  <p>This API must be only exposed to trusted content.</p>
</section>


<!---------------------- Extended interface Navigator ------------------------>
<section>
  <h2><a>Telephony</a> object</h2>
  <p>The <a>TelephonyManager</a> interface is exposed on the <code>Navigator
  </code> object.
  </p>
  <dl title="partial interface Navigator" class="idl">
    <dt>readonly attribute TelephonyManager telephony</dt>
    <dd>The object that exposes the telephony functionality, e.g. making and
    receiving calls. While multiple telephony services may be used for making
    calls, received calls from all telephony services are handled through
    this object, since all calls are competing for the same resources, and
    arbitration is needed.</dd>
  </dl>
</section>


<!------------------------ Interface TelephonyManager ------------------------>
<section>
  <h2><a>TelephonyManager</a> Interface</h2>
  <p>The <a>TelephonyManager</a> interface defines access to telephony
  functionality, and manages the <a><code>TelephonyCall</code></a> objects
  lifecycle. There are 3 ways <code>TelephonyCall</code> objects can be
  created:<ul>
  <li>using the <code>dial()</code> method</li>
  <li>when there is an incoming or waiting call</li>
  <li>when a call is split from a multiparty call</li>
  </ul>All these methods will be discussed later in this document.
  </p>

  <dl title="[NoInterfaceObject]
             interface TelephonyManager : EventTarget"
          class="idl">

    <dt>readonly attribute TelephonyCall activeCall</dt>
    <dd>MUST return a <a>TelephonyCall</a> object representing the <a>active
    call</a>, otherwise it MUST return <code>null</code>.</dd>

    <dt>readonly attribute TelephonyCall[] calls</dt>
    <dd>MUST return an array of all <code>TelephonyCall</code> objects present
    in the system. Otherwise it MUST return an empty list.</dd>

    <dt>attribute <a>TelephonyAudioControl</a> audioControl</dt>
    <dd>MUST return a <a>TelephonyAudioControl</a> object, exposing
    functionality for audio volume settings.</dd>

    <dt>readonly attribute DOMString[] emergencyNumbers</dt>
    <dd>Indicates the telephone number, or list thereof, of the emergency
    service in the current geographical area.</dd>

    <!-- instead of ownTelNumbers, which returned the/a list of own numbers,
    TelephonyService id is used (having as a value the phone number). -->
    <dt>readonly attribute DOMString[] serviceIds;
    <dd>MUST return the list of available <a>telephony service id</a>'s. For
    cellular telephony, implementations MUST use the MSISDN (phone number) as
    service identifier.</dd>

    <dt>attribute DOMString activeId;
    <dd>MUST return, or set the default <a>telephony service id</a>.</dd>

    <dt> TelephonyCall dial ()</dt>
    <dd>Allows to initiate a new telephony call. Returns a <a><code>
    TelephonyCall</code></a> object, which will manage the asynchronous call
    signaling events.
      <dl class='parameters'>
        <dt>DOMString number</dt>
        <dd>Indicates the destination number of the call</dd>

        <dt>optional DialParams params</dt>
        <dd>If set, indicates the optional parameters of the call</dd>
      </dl>
    </dd>

    <dt>void sendTones()</dt>
    <dd>This method asynchronously emits a DTMF tone sequence with the default
    or specified duration and delay, in the active or the specified telephony
    service.
      <dl class='parameters'>
        <dt>DOMString tone</dt>
        <dd>Indicates the DTMF tone, or sequence thereof, to be emitted. Its
        value can be any sequence of the following characters (0-9; A-D; *; #),
        each identifying a tone.
        </dd>

        <dt>optional ToneParams params</dt>
        <dd>If set, indicates the <a>telephony service id</a> to be used, the
        tone durations and delay before a tone. If not set, implementations
        MUST use default values for these.</dd>
      </dl>
    </dd>

    <dt class="no-docs"> attribute EventHandler onincoming</dt>
    <dd>Whenever there is a new call in
    <a href='#call-state-connected'><code>incoming</code></a> or
    <a href='#call-state-connected'><code>waiting</code></a> state, the
    <a>user agent</a> MUST <a>queue a task</a> to fire an event named
    <code>incoming</code> of type <a>TelephonyEvent</a>.
    The <code>param</code> property of the event MUST be set to the incoming
    <a><code>TelephonyCall</code></a> object.</dd>

    <dt class="no-docs"> attribute EventHandler oncallsplit</dt>
    <dd>Whenever a call is split off a multiparty call, the <a>user agent</a>
    MUST <a>queue a task</a> to fire an event named <code>callsplit</code> of
    type <code>TelephonyEvent</code>.
    The <code>param</code> property of the event MUST be set to the new
    <a><code>TelephonyCall</a></code> object representing the split call.</dd>

    <dt class="no-docs"> attribute EventHandler oncallschanged</dt>
    <dd>Whenever a call is added to or removed from the <code>calls</code>
    array, the <a>user agent</a> MUST <a>queue a task</a> to <a>fire a simple
    event</a> named <code>callschanged</code>.</dd>

    <dt class="no-docs"> attribute EventHandler onserviceadded</dt>
    <dd>The <code>serviceadded</code> event of type <a>TelephonyEvent</a> MUST
    be fired whenever a new <a>telephony service</a> is enabled in the system.
    The <code>param</code> property of the event MUST contain the <a>telephony
    service id</a> of the new service.</dd>

    <dt class="no-docs"> attribute EventHandler onserviceremoved</dt>
    <dd>The <code>serviceremoved</code> event of type <a>TelephonyEvent</a> MUST
    be fired when an existing <a>telephony service</a> is disabled in the
    system. The <code>param</code> property of the event MUST contain the
    <a>telephony service id</a> of the disabled service.</dd>
  </dl>

  <section>
  <h3>Event handlers</h3>
  <p>The following are the <a>event handlers</a> (and their corresponding
  <a>event handler types</a>)that MUST be supported as attributes by the
  <a>Telephony</a> object.
  <table class="simple">
    <thead>
      <tr>
        <th>event handler</th>
        <th>event name</th>
        <th>event type</th>
        <th>short description</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><strong><code>onincoming</code></strong></td>
        <td><code><dfn>incoming</dfn></code></td>
        <td><a><code>TelephonyEvent</code></a> with <code>param</code>
        property set to the new <a><code>TelephonyCall</code></a> object
        </td>
        <td>handle incoming and waiting calls</td>
      </tr>
      <tr>
        <td><strong><code>onsplit</code></strong></td>
        <td><code><dfn>split</dfn></code></td>
        <td><a><code>TelephonyEvent</code></a> with <code>param</code>
        property set to the new <a><code>TelephonyCall</code></a> object
        </td>
        <td>handle split calls</td>
      </tr>
      <tr>
        <td><strong><code>oncallschanged</code></strong></td>
        <td><code><dfn>callschanged</dfn></code></td>
        <td><a><code>TelephonyEvent</code></a> with <code>param</code>
        property set to an array of changed <a><code>TelephonyCall</code>
        </a> objects.</td>
        <td>handle any change in <a><code>TelephonyCall</code></a> objects</td>
      </tr>
      <tr>
        <td><strong><code>onserviceadded</code></strong></td>
        <td><code><dfn>serviceadded</dfn></code></td>
        <td><a><code>TelephonyEvent</code></a> with <code>param</code> property
        set to the new <a>telephony service id</a> as <code>DOMString</code>
        </td>
        <td>handle new <a>telephony service</a>s</td>
        </td>
      </tr>
      <tr>
        <td><strong><code>onserviceremoved</code></strong></td>
        <td><code><dfn>serviceremoved</dfn></code></td>
        <td><a><code>TelephonyEvent</code></a> with <code>param</code> property
        set to the removed <a>telephony service id</a> as <code>DOMString</code>
        </td>
        <td>handle disabled <a>telephony service</a>s</td>
        </td>
      </tr>
    </tbody>
  </table>
  </section> <!-- Event handlers -->
      
  <section id="telephonymanager-steps">
  <h3>Steps</h3>
  <p> The <code>dial</code> method when invoked MUST run the following steps:
  <ol id="steps-dial">
    <li>Let <var>telCall</var> be a newly created <code>TelephonyCall</code>
    object</li>
    <li>Add the telephone number specified in the <code>number</code> parameter
    to the <code>participants</code> array of <var>telCall</var></li> 
    <li>If <code>calls</code> array already contains a <a>TelephonyCall</a>
    object associated to the <code>number</code> parameter, then go to
    <a href="#error-step">error steps</a>.
    <li>Otherwise, execute the following steps: <ol>
      <li>Make a request to the telephony system to dial in the telephone number
      passed in the <code>number</code> parameter. According to the value of the
      <code>hideCallerId</code> in the <code>params</code> parameter, own
      number is requested to be either displayed, hidden or otherwise the
      default system configuration to this regard is requested to be followed.
      </li>
      <li>If the request progress successfully, then <ol>
        <li>Add <var>telCall</var> to the <code>calls</code> array</li>
        <li>Set the <code>state</code> of <var>telCall</var> to
        <a href="#call-state-dialing"><code>dialing</code></a> value</li>
        <li><a>Queue a task</a> to <a>fire a simple event</a> named
        <code><a>statechange</a></code> at the <var>telCall</var> object</li>
        <li><a>Queue a task</a> to <a>fire a simple event</a> named <code><a>
        dialing</a></code> at the <var>telCall</var> object</li>
        <li>and finally return to the caller and <a>queue a task</a>
        <i>TCallControl</i> to monitor call flow progress</ol>
      <li>If during further steps for call connection there is an error, go to
      <a href="#error-steps">error steps</a>.</li>
    </ol>
  </ol></p>
  
  <p>Upon a new incoming or waiting call, the <a>user agent</a> MUST execute the
  following steps:
  <ol id="steps-incoming">
    <li>Let <var title="">incomingCall</var> be a new instance of
    <code>TelephonyCall</code>.</li>
    <li>Set the <code>state</code> of <var>incomingCall</var> to
    <a href="#call-state-incoming"><code>incoming</code></a> in case there is
    no other call in <a href="#call-state-connected"><code>connected</code></a>
    state, or otherwise to <a href="#call-state-waiting"><code>waiting</code>
    </a></li>
    <li>Add <var title="">incomingCall</var> to the <code>calls</code> array
    </li>
    <li><a>Queue a task</a> to <a>fire a simple event</a> named <code><a>
    statechange</a></code> at the <var>incomingCall</var> object</li>
    <li><a>Queue a task</a> to <a>fire a simple event</a> named <code><a>
    incoming</a></code> at the <a><code>TelephonyManager</code></a> object
    managing the call</li>
    <li><a>Queue a task</a> to <a>fire a simple event</a> named <code><a>
    callschanged</a></code> at the <a><code>TelephonyManager</code></a> object
    managing the call</li>
    <li><a>Queue a task</a> <i>TCallControl</i> to monitor call flow progress.
    </li>
  </ol></p>

  <p class="issue">The <code>incoming</code> event has to be defined according
  to DOM4.
  </p>

  The task <i>TCallControl</i> MUST listen to any event that results in a
  call disconnection, and upon such events, follow the steps described for
  <a href='#steps-disconnect-system'>handling disconnected calls</a>.

  <p>The <code>sendTones()</code> method when invoked MUST make a request to the
  telephony system to start sending the tones passed in the <code>tones</code>
  parameter to the active TelephonyCall object, using the default tone duration,
  and delay, unless a different <a>telephony service</a>, tone duration, and/or
  delay is specified.
  If the request is acknowledged, then return to the caller. If there is an
  error, <a>queue a task</a> to <a>fire a simple event</a> named <a><code>error
  </code></a> at the <a><code>TelephonyManager</code></a> object managing the
  call.</p>
  </section> <!-- telephonymanager-steps -->

  <section id="telephonymanager-error-steps">
  <h3>Error Steps</h3>
  <p><ol>
    <li>Set the state of <var>telCall</var> to
    <a href="#call-state-error"><code>error</code></a></li>
    <li>queue a task to fire a simple event named <a><code>error</code></a> at
    the <var>telCall</var> object.</li>
  </ol></p>
  </section> <!-- error steps -->

<!------------------------- Dictionary DialParams ---------------------------->
  <section>
  <h3><a>DialParams</a> Dictionary</h3>
  <dl title="dictionary DialParams" class="idl">
    <dt>DOMString hideCallerId</dt>
    <dd>Indicates whether the own number is to be hidden or displayed to the
    called remote party, or otherwise the default system configuration to this
    regard is to be followed. It may have the following values: <code>'display'
    </code>, <code>'hide'</code> and <code>'default'</code>.
    If not specified, the implementation MUST provide a default value.</dd>

    <dt>DOMString serviceId</dt>
    <dd>Indicates the <a>telephony service id</a> of the <a>telephony service
    </a> to be used when dialing. If not specified, the implementation MUST
    provide a default value.</dd>
  </dl>
  </section>


<!------------------------- Dictionary ToneParams ---------------------------->
  <section>
  <h3><a>ToneParams</a> Dictionary</h3>
  <dl title="dictionary ToneParams" class="idl">
    <dt>unsigned long duration</dt>
    <dd>Indicates the duration in milliseconds of the DTMF tones to be sent.
    If not specified, the implementation MUST provide a default value.</dd>

    <dt>unsigned long gap</dt>
    <dd>Indicates the duration in milliseconds of the time gap before sending
    a DTMF tone. If not specified, the implementation MUST provide a default
    value.</dd>

    <dt>DOMString serviceId</dt>
    <dd>Indicates the <a>telephony service id</a> of the <a>telephony service
    </a> to be used when dialing. If not specified, the implementation MUST
    provide a default value.</dd>
  </dl>
  </section>

</section> <!-- TelephonyManager -->


<!-------------------- Interface TelephonyAudioControl ----------------------->
<section>
  <h2><a>TelephonyAudioControl</a> Interface</h2>
  <p>The <a>TelephonyAudioControl</a> interface represents the object
  for controlling audio volume, microphone volume, and muting state.</li>
  </p>
  <dl title="[NoInterfaceObject]
           interface TelephonyAudioControl : EventTarget"
        class="idl">

    <dt>attribute double audioVolume</dt>
    <dd>MUST return or set the normalized volume of the active audio output,
    ranging from 0.0 (silent) to 1.0 (loudest).</dd>

    <dt>attribute boolean audioMuted</dt>
    <dd>MUST return or set <code>true</code> when the active audio target (e.g.
    speaker or headset) is muted, and <code>false</code> otherwise. 
    When unmuting, volume MUST be restored to the value of <a>audioVolume</a>
     attribute.</dd>

    <dt>attribute double micVolume</dt>
    <dd>MUST return or set the normalized volume of the microphone input level,
    ranging from 0.0 (silent) to 1.0 (loudest).</dd>

    <dt>attribute boolean micMuted</dt>
    <dd>MUST return or set <code>true</code> when the active microphone is 
    muted, and <code>false</code> otherwise. When unmuted, the microphone volume
    MUST be restored to the value of <a>micVolume</a> attribute.</dd>

   <dt class='no-docs'> attribute Eventhandler onvolumechanged</dt>
   <dd>The simple event <code>volumechanged</code> MUST be fired when the audio
   or microphone volume is changed.</dd>
  </dl>
</section>


<!------------------------- Interface TelephonyCall -------------------------->
<section>
  <h2><a>TelephonyCall</a> Interface</h2>
  <dl title="[NoInterfaceObject]
    interface TelephonyCall : EventTarget"
    class="idl">
    <dt>readonly attribute DOMString[] participants</dt>
    <dd>It MUST return the array of remote party identifiers (telephone numbers)
    of the call participants, excluding that of the caller.</dd>

    <dt>readonly attribute DOMString serviceId</dt>
    <dd>It MUST return the <a>telephony service id</a> of the 
    <a>telephony service </a> used for the call.</dd>

    <dt>readonly attribute DOMString state</dt>
    <dd>It MUST return the state of the call (see below).</dd>

    <dt>readonly attribute DOMError error</dt>
    <dd>An error that occured during the call lifecycle. Errors are as defined 
    in [[!DOM4]].</dd>

    <dt>void answer()</dt>
    <dd>Answers an incoming telephone call.</dd>

    <dt>void disconnect()</dt>
    <dd>Terminates a telephone call.</dd>

    <dt>void hold()</dt>
    <dd>Puts a telephone call on hold.</dd>

    <dt>void resume()</dt>
    <dd>Resumes a telephone call that had been previously put on hold.</dd>

    <dt>void redirect(in DOMString redirectNumber)</dt>
    <dd>Redirects an incoming telephone call to another telephone number.</dd>
    
    <dt>void addParticipant(DOMString number)</dt>
    <dd>Put the current multiparty call on hold, place a new call to the 
    specified remote party and when active, join with the held multiparty call
    and activate it.
      <dl class='parameters'>
        <dt>DOMString number</dt>
        <dd>Indicates the destination number of the new call participant</dd>
      </dl>
</dd>
    
    <dt>void removeParticipant(DOMString number)</dt>
    <dd>Request dropping a participant from the call.
      <dl class='parameters'>
        <dt>DOMString number</dt>
        <dd>Indicates the call participant to be removed from the multiparty
        call</dd>
      </dl>
    </dd>
    
    <dt>void split(DOMString number)</dt>
    <dd>Splits from the current multiparty call a new private call with the
    specified call participant, activates it and puts the multiparty call on
    hold.
      <dl class='parameters'>
        <dt>DOMString number</dt>
        <dd>Indicates the call participant to split off from the multiparty call
        </dd>
      </dl>
    </dd>

    <dt class="no-docs">attribute EventHandler onstatechange</dt>
    <dd></dd>
    <dt class="no-docs">attribute EventHandler ondialing</dt>
    <dd></dd>
    <dt class="no-docs">attribute EventHandler onalerting</dt>
    <dd></dd>
    <dt class="no-docs">attribute EventHandler onaccepted</dt>
    <dd></dd>
    <dt class="no-docs">attribute EventHandler onconnecting</dt>
    <dd></dd>
    <dt class="no-docs">attribute EventHandler onconnected</dt>
    <dd></dd>
    <dt class="no-docs">attribute EventHandler ondisconnecting</dt>
    <dd></dd>
    <dt class="no-docs">attribute EventHandler ondisconnected</dt>
    <dd></dd>
    <dt class="no-docs">attribute EventHandler onholding</dt>
    <dd></dd>
    <dt class="no-docs">attribute EventHandler onheld</dt>
    <dd></dd>
    <dt class="no-docs">attribute EventHandler onresuming</dt>
    <dd></dd>
    <dt class="no-docs">attribute EventHandler onredirecting</dt>
    <dd></dd>
    <dt class="no-docs">attribute EventHandler onerror</dt>
    <dd></dd>
  </dl>

  <section id="telephony-eventhandlers">
  <h3>Event handlers</h3>
  <p>The following are the <a>event handlers</a> MUST be supported as attributes
   by the <a><code>TelephonyCall</code></a> object:
  <table class="simple">
    <thead>
      <tr>
        <th>event handler</th>
        <th>event name</th>
        <th>event type</th>
        <th>short description</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><strong><code>onstatechange</code></strong></td>
        <td><code><dfn>statechange</dfn></code></td>
        <td><a>simple event</a></td>
        <td>fired whenever there is a call state change</td>
      </tr>
      <tr>
        <td><strong><code>ondialing</code></strong></td>
        <td><code><dfn>dialing</dfn></code></td>
        <td><a>simple event</a></td>
        <td>fired when the call state changes to <code>"dialing"</code></td>
      </tr>
      <tr>
        <td><strong><code>onalerting</code></strong></td>
        <td><code><dfn>alerting</dfn></code></td>
        <td><a>simple event</a></td>
        <td>fired when the call state changes to <code>"alerting"</code></td>
      </tr>
      <tr>
        <td><strong><code>onaccepted</code></strong></td>
        <td><code><dfn>accepted</dfn></code></td>
        <td><a>simple event</a></td>
        <td>fired when the call state changes to <code>"accepted"</code></td>
      </tr>
      <tr>
        <td><strong><code>onconnecting</code></strong></td>
        <td><code><dfn>connecting</dfn></code></td>
        <td><a>simple event</a></td>
        <td>fired when the call state changes to <code>"connecting"</code></td>
      </tr>
      <tr>
        <td><strong><code>onconnected</code></strong></td>
        <td><code><dfn>connected</dfn></code></td>
        <td><a>simple event</a></td>
        <td>fired when the call state changes to <code>"connected"</code></td>
      </tr>
      <tr>
        <td><strong><code>ondisconnecting</code></strong></td>
        <td><code><dfn>disconnecting</dfn></code></td>
        <td><a>simple event</a></td>
        <td>fired when the call state changes to <code>"disconnecting"</code>
        </td>
      </tr>
      <tr>
        <td><strong><code>ondisconnected</code></strong></td>
        <td><code><dfn>disconnected</dfn></code></td>
        <td><a><code>TelephonyEvent</code></a></td>
        <td>fired when the call state changes to <code>"disconnected"</code>
        </td>
      </tr>
      <tr>
        <td><strong><code>onholding</code></strong></td>
        <td><code><dfn>holding</dfn></code></td>
        <td><a>simple event</a></td>
        <td>fired when the call state changes to <code>"holding"</code></td>
      </tr>
      <tr>
        <td><strong><code>onheld</code></strong></td>
        <td><code><dfn>held</dfn></code></td>
        <td><a>simple event</a></td>
        <td>fired when the call state changes to <code>"held"</code></td>
      </tr>
      <tr>
        <td><strong><code>onresuming</code></strong></td>
        <td><code><dfn>resuming</dfn></code></td>
        <td><a>simple event</a></td>
        <td>fired when the call state changes to <code>"resuming"</code></td>
      </tr>
      <tr>
        <td><strong><code>onredirecting</code></strong></td>
        <td><code><dfn>redirecting</dfn></code></td>
        <td><a>simple event</a></td>
        <td>fired when the call state changes to <code>"redirecting"</code></td>
      </tr>
      <tr>
        <td><strong><code>onerror</code></strong></td>
        <td><code><dfn>error</dfn></code></td>
        <td><a>simple event</a></td>
        <td>fired when there is an error</code></td>
      </tr>
    </tbody>
  </table>
  </section> <!-- telephony-eventhandlers -->

  <section id="telephony-steps">
  <h3>Steps</h3>
  <p>The IDL attribute <dfn title="call-state"><code>state</code></dfn> MUST
  return the current status of the call. It MUST be one of the following values:
  <table class="simple">
    <thead>
      <tr>
        <th>call state</th>
        <th>string value</th>
        <th>description</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><dfn id="call-state-dialing"><code>dialing</code></dfn></td>
        <td><code>'dialing'</code></td>
        <td>An outbound call that has been dialed and is being connected</td>
      </tr>
      <tr>
        <td><dfn id="call-state-connecting"><code>connecting</code></td>
        <td><code>'connecting'</code></td>
        <td>A request to establish the call has been made and it is progressing
        </td>
      </tr>
      <tr>
        <td><dfn id="call-state-alerting"><code>alerting</code></td>
        <td><code>'alerting'</code></td>
        <td>The destination number has been reached and alerting is taking place
        </td>
      </tr>
      <tr>
        <td><dfn id="call-state-connected"><code>connected</code></dfn></td>
        <td><code>'connected'</code></td>
        <td>The call is ongoing</td>
      </tr>
      <tr>
        <td><dfn id="call-state-disconnecting"><code>disconnecting</code></td>
        <td><code>'disconnecting'</code></td>
        <td>A request to disconnect the call has been made and it is progressing
        </td>
      </tr>
      <tr>
        <td><dfn id="call-state-disconnected"><code>disconnected</code></dfn></td>
        <td><code>'disconnected'</code></td>
        <td>The call has been disconnected</td>
      </tr>
      <tr>
        <td><dfn id="call-state-incoming"><code>incoming</code></dfn></td>
        <td><code>'incoming'</code></td>
        <td>An incoming call is being received whilst no other call is
        progressing</td>
      </tr>
      <tr>
        <td><dfn id="call-state-waiting"><code>waiting</code></dfn></td>
        <td><code>'waiting'</code></td>
        <td>An incoming call that has been received whilst there was another 
        call progressing, and the call waiting service is active.</td>
      </tr>
      <tr>
        <td><dfn id="call-state-accepted"><code>accepted</code></dfn></td>
        <td><code>'accepted'</code></td>
        <td>An incoming call has been answered and is being connected</td>
      </tr>
      <tr>
        <td><dfn id="call-state-holding"><code>holding</code></dfn></td>
        <td><code>'holding'</code></td>
        <td>The call is being put on hold</td>
      </tr>
      <tr>
        <td><dfn id="call-state-held"><code>held</code></dfn></td>
        <td><code>'held'</code></td>
        <td>The call has been put on hold</td>
      </tr>
      <tr>
        <td><dfn id="call-state-resuming"><code>resuming</code></td>
        <td><code>'resuming'</code></td>
        <td>The call, which was on hold, is being resumed</td>
      </tr>
      <tr>
        <td><dfn id="call-state-redirecting"><code>redirecting</code></dfn></td>
        <td><code>'redirecting'</code></td>
        <td>The call is being redirected to another remote party from the same
        <a>telephony service</a></td>
      </tr>
    </tbody>
  </table></p>
 
  <!--
   =========================================================================
   CDMA states for dialed calls   | Mapping to the API or [modem] state
   _________________________________________________________________________
   [ DIAL button pressed ]        | dialing
   -> channel request             |
   <- immediate assignment        |
   -> service request             |
   <- authentication request      |
   -> authentication response     |
   <- cyphering command           |
   -> cyphering complete          |
   -> setup                       |
   <- call confirmed              |
   <- assignment command          |
   -> assignment completed        |
   <- alerting                    | alerting
   <- connect                     |
   -> connect ack                 | connected
   <-> dataspeech                 |
   _________________________________________________________________________
   CDMA states for received calls | Mapping to the API or [modem] state
   _________________________________________________________________________
   <- paging request              |
   -> channel request             |
   <- immediate assignment        |
   -> paging response             |
   <- authentication request      |
   -> authentication response,    |
   <- cyphering command           |
   -> cyphering complete          |
   <- call setup                  |
   -> call confirmed              | incoming
   <- assignment command          |
   -> assignment complete         |
   -> call alerting               | [ringing]
   [ OK button pressed ]          | accepted
   -> connect                     |
   <- connect ack                 | connected
   <-> dataspeech                 |
   =========================================================================
   GSM states for dialed calls    | Mapping to the API or [modem] state
   _________________________________________________________________________
   [ DIAL button pressed ]        | dialing
   -> channel request             |
   <- immediate assignment        |
   -> service request             |
   -> connection request          |
   <- cyphering command           |
   -> cyphering complete          |
   -> call setup                  |
   <- connecting                  | connecting
   [call mode: signaling -> voice]|
   [routing, voicemail, errors]   |
   <- call confirmed              |
   <- alerting                    | alerting
   <- connect                     |
   -> connect ack                 | connected
   <-> dataspeech                 |
   _________________________________________________________________________
   GSM states for received calls  | Mapping to the API or [modem] state
   _________________________________________________________________________
   <- interrogation procedure     |
   <- paging request              |
   -> channel request             |
   <- immediate assignment        |
   -> paging response             |
   - cyphering                    |
   <- call setup                  | incoming
   -> call confirmed              |
   -> call alerting               | [ringing]
   [ OK button pressed ]          | accepted
   -> connect                     |
   <- connect ack                 | connected
   <-> dataspeech                 |
   =========================================================================
   SIP/IMS states for dialed calls| Mapping to the API or [SIP stack] state
   _________________________________________________________________________
   [ DIAL button pressed ]        | dialing
   -> SIP Invite                  | [initializing]
   <- SIP 183 Session Progress    |
   [ SDP ]                        |
   -> PRACK                       | [initialized]
   [Caller PDP Context activation]|
   <- SIP 200 OK                  |
   -> UPDATE [ context ]          |
   <- SIP 200 OK                  |
   [ remote starts ringing ]      |
   <- SIP 180 RINGING             | alerting
   -> PRACK                       |
   [ remote answers]              |
   <- SIP 200 OK                  |
   -> ACK                         | connected
   <-> dataspeech                 |
   _________________________________________________________________________
   SIP states for received calls  | Mapping to the API or [SIP stack] state
   _________________________________________________________________________
   <- SIP Invite                  | incoming
   -> SIP 183 Session Progress    | [initializing]
   [ SDP ]                        |
   <- PRACK                       |
   -> SIP 200 OK                  | [initialized]
   [ PDP Context activation]      |
   <- UPDATE [ context ]          |
   -> SIP 200 OK                  |
   [ locally ringing ]            | 
   -> SIP 180 RINGING             | [ringing]
   <- PRACK                       |
   [ answers ]                    | accepted
   -> SIP 200 OK                  |
   <- ACK                         | connected
   <-> dataspeech                 |
   =========================================================================
   XMPP states for dialed calls   | Mapping to the API or [XMPP stack] state
   [ XMPP XEP-0166 Jingle ]       | (may depend on XMPP implementation)
   _________________________________________________________________________
   DIAL button pressed            | dialing
   -> session-initiate            |
   <- ack                         |
   <- session-accept              | alerting
   -> ack                         | connected
   <-> media session              |
   <- session-terminate           |
   -> ack                         | disconnected
   _________________________________________________________________________
   XMPP states for received calls | Mapping to the API or [XMPP stack] state
   [ XMPP XEP-0166 Jingle ]       | (may depend on XMPP implementation)
   _________________________________________________________________________
   <- session-initiate            | incoming
   -> ack                         |
   [ locally ringing ]            | [ringing]
   [ user accepts ]               | accepted
   -> session-accept              |
   <- ack                         | connected
   <-> media session              |
   -> session-terminate           | disconnecting
   <- ack                         | disconnected
   _________________________________________________________________________
   -->
  
  <p>Some of these states are <dfn>soft states</dfn>, that is, transitory states
  in which the application is placed after making a request to the telephony
  system and until it is completed. For instance the application remains in
  <code>"holding"</code> state since it invokes the hold() method and until the
  telephony system actually holds the call. In some implementations these soft
  states can be skipped. The following are the soft states defined by this
  specification:
  <ol>
    <li><code>"accepted"</code></li>
    <li><code>"disconnecting"</code></li>
    <li><code>"dialing"</code></li>
    <li><code>"holding"</code></li>
    <li><code>"resuming."</code></li>
  </ol>
  </p>

  <p>On the contrary <dfn>hard states</dfn> map with actual call states.
  </p>

  <p>The implementation MUST follow the call state changes in the supported
  telephony backend(s) and networks, and MUST keep the <code>state</code>
  property updated. Since call state transitions depend on protocol, network
  equipment, modem, etc., the implementation MUST NOT fire error events on 
  assumed erronous state transitions.
  Applications MUST always re-synchronize any eventual internal states to the 
  current call state reported by the telephony system.
  The implementation MUST NOT set the call state to any other value than
  specified in the descriptions of the methods of this interface.</p>
  
  <p>Whenever there is a change in the <code>state</code> attribute the
  <a>user agent</a> MUST:<ol>
  <li>Queue a task to fire a simple event named <code><a>statechange</a></code>
  <li>Queue a task to fire a simple event which name will be equal to the new
  value of the state attribute.</li>
  </li>
  </ol></p>
   
  <p>For call setup on received calls, the following call states MUST be 
  supported in this order: <ol>
  <li><code>"incoming"</code>/<code>"waiting"</code></li>
  <li><code>"accepted"</code></li>
  <li><code>"connected".</code></li>
  </ol></p>
  <p class="note">On received calls, telephony protocols also use a
  <code>"ringing"</code> state, set by the mobile terminal when local call
  alerting starts, in order to notify the remote party about the ongoing
  alerting (ringing can actually be e.g. a beep, ring tone, or vibration
  pattern). This is considered to be responsibility of implementations.
  If this state is expected to be set on the modem, implementations MUST set it.
  Dialer applications are not expected to set this state in the current version
  of the specification.
  </p>

  <p>For call setup on dialed calls, the following call states MUST be 
  supported in this order: <ol>
  <li><code>"dialing"</code></li>
  <li><code>"alerting"</code></li>
  <li><code>"connected".</code></li></ol></p>
  <p class="note">
  On the telephony services which support the <code>"connecting"</code> call
  state (e.g. GSM and CDMA, for call routing, forwarding, voicemail handling
  etc), implementations SHOULD support this state too, between the
  <code>"dialing"</code> and <code>"alerting"</code> states.
  Dialer applications can associate the protocol with the <a>telephony service
  </a> used for the call.
  </p>
  
  <p>When <i>TCallControl</i> is notified that a dialed call is in the process
  of being connected, it MUST set <code>state</code> to
  <a href="#call-state-connecting"><code>connecting</code></a>.</p>

  <p>When <i>TCallControl</i> is informed that the connection has been
  established, it MUST set <code>state</code> to
  <a href="#call-state-connected"><code>connected</code></a>.</p>

  <p>If there is any error during call progressing then the
  <a href="#error-steps">error steps</a> MUST be executed.</p>

  <p>The <code>disconnect</code> method when invoked MUST run the following
  steps:
  <ol id="steps-disconnect-client">
    <li>Set the <code>state</code> of <var>telCall</var> to
    <a href='#call-state-disconnecting'><code>disconnecting</code></a></li>
    <li><a>Queue a task</a> to <a>fire a simple event</a> named <code><a>
    statechange</a></code> at the <var>telCall</var> object</li>
    <li><a>Queue a task</a> to <a>fire a simple event</a> named <code><a>
    disconnecting</a></code> at the <var>telCall</var> object</li>
    <li>Request from the telephony system the disconnection of the call</li>
  </ol>

  <p>When <i>TCallControl</i> is notified of actual call disconnection it MUST
  follow the next steps:  
    <ol id="steps-disconnect-system">
    <li>Set the <code>state</code> of <var>telCall</var> to
    <a href='#call-state-disconnected'><code>disconnected</code></a></li>
    <li><a>Queue a task</a> to <a>fire a simple event</a> named <code><a>
    statechange</a></code> at the <var>telCall</var> object</li>
    <li><a>Queue a task</a> to <a>fire a simple event</a> named <code><a>
    disconnected</a></code> at the <var>telCall</var> object</li>
    <li>Remove the <var>telCall</var> object from the <code>calls</code> array.
    </li>
  </ol></p>
  
  <p>The <code>param</code> property of the <code>disconnected</code> event MUST
  be set to the disconnect reason as <code>DOMString</code>, if available, 
  otherwise it MUST be set to <code>null</code>. At least the following values 
  MUST be supported for the disconnect reason: <ul>
  <li><code>"local"</code>: the call was disconnected by the user, or the device,
  and no more specific reason is known</li>
  <li><code>"remote"</code>: the call was disconnected by the remote party, and
  no more specific reason is known</li>
  <li><code>"network"</code>: the call was disconnected by the network, and no
  more specific reason is known</li>
  </ul>
  In addition, the following disconnect reasons SHOULD be supported:<ul>
  <li><code>"redirected"</code>: the call has been redirected</li>
  <li><code>"busy"</code>: the call was disconnected by the network, because
  the remote party was busy</li>
  <li><code>"unreachable"</code>: the call was disconnected by the network,
  because the remote party was unreachable</li>
  <li><code>"no-answer"</code>: the call was disconnected by the network,
  because the remote party has not answered and the call has timeouted</li>
  <li><code>"network-unreachable"</code>: the call was disconnected because
  the network was unreachable</li>
  <li><code>"barred"</code>: the call was disconnected because it was barred
  </li>
  <li><code>"rejected"</code>: the call was disconnected because the remote
  party rejected the call</li>
  <li><code>"no-service"</code>: the call was not made because there is no
  telephony service set up and enabled (e.g. no SIM card)</li>
  <li><code>"invalid-number"</code>: the call was disconnected by the network,
  because the remote party identifier was invalid.</li>
  </ul></p>


  <p>The <code>hold</code> method when invoked MUST run the following steps:<ol>
  <li>If <code>state</code> is not equal to <a href="#call-state-connected">
  <code>connected</code></a>, raise an <code>ILLEGAL_STATE</code> exception
  </li>
  <li>Otherwise make a request to the telephony system to hold the call. If the
  request is acknowledged then set <code>state</code> to
  <a href="#call-state-holding"><code>holding</code></a>.
  </li></ol></p>

  <p>When <i>TCallControl</i> is notified that the call has been put on hold it
  MUST set <code>state</code> to <a href="#call-state-held"><code>held</code>
  </a>.</p>

  <p>The <code>resume</code> method when invoked MUST run the following steps:
  <ol><li>If <code>state</code> is not equal to <a href="#call-state-held">
  <code>held</code></a>, raise an <code>ILLEGAL_STATE</code> exception
  </li>
  <li>Otherwise make a request to the telephony system to resume the call. If
  the request is acknowledged, then set <code>state</code> to
  <a href="#call-state-resuming"><code>resuming</code></a>.</li>
  </ol></p>

  <p>When <i>TCallControl</i> detects that the call has being actually resumed
  it MUST set <code>state</code> to <a href="#call-state-connected">
  <code>connected</code></a>.</p>

  <p>The <code>answer</code> method when invoked MUST run the following steps:
  <ol><li>If <code>state</code> is not equal to
  <a href="#call-state-incoming"><code>incoming</code></a> or
  <a href="#call-state-waiting"><code>waiting</code></a>, raise an
  <code>ILLEGAL_STATE</code> exception
  </li>
  <li>Otherwise make a request to the telephony system to answer the call.
  If the request is acknowledged then set <code>state</code> to
  <a href="#accepted"><code>accepted</code></a>.
  </li>
  </ol></p>

  <p>The <code>redirect</code> method when invoked MUST run the following steps:
  <ol><li>If <code>state</code> is not equal to <a href="#call-state-incoming">
  <code>incoming</code></a> or <a href="#call-state-waiting"><code>waiting
  </code></a>, raise an <code>ILLEGAL_STATE</code> exception</li>
  <li>Otherwise make a request to the telephony system to redirect the call to
  the number indicated in the <var>redirectNumber</var> parameter.
  If the request is acknowledged, then set <code>state</code> to
  <a href="#call-state-redirecting"><code>redirecting</code></a>.</li>
  </ol></p>
  
  <p>When <i>TCallControl</i> is notified that the call has been successfully
  redirected it MUST set <code>state</code> to
  <a href="#call-state-disconnected"><code>disconnected</code></a>.</p>

  <p>The following figure depicts the most usual state transitions for received
  calls:</p>
  <br>
  <div style="text-align: left">
    <img src="images/inbound_call_state_diagram.gif"
    alt="Inbound Call State Diagram" title="Inbound Call State Diagram">
  </div>
  <br>
  <br>
      
  <p>The following figure depicts the most usual state transitions for dialed
  calls:</p>
  <br>
  <div style="text-align: left">
   <img src="images/outbound_call_state_diagram.gif"
    alt="Outbound Call State Diagram" title="Outbound Call State Diagram">
  </div>
  <br>
      
  <p>The <code>addParticipant</code> method when invoked MUST run the following
  steps:<ol>
  <li>If the call is not a multiparty call, raise an <code>ILLEGAL_STATE</code>
  exception</li>
  <li>Otherwise make a request to the telephony system to add a participant to
  the multiparty call. Depending on system implementation this may require
  different steps, but usually this involves: <ol>
    <li>put the multiparty call on hold</li>
    <li>make a call to the specified number>/li>
    <li>join the new call with the multiparty call on hold</li>
    <li>activate the multiparty call.</li></ol>
  </li></ol></p>
  
  <p>The <code>removeParticipant</code> method when invoked MUST run the
  following steps: <ol>
  <li>If the provided remote party identifier (phone number) is not a member of 
  the current call, raise an <code>ILLEGAL_STATE</code> exception</li>
  <li>Otherwise, if the call is not a multiparty call, follow the steps for
  <a href="#steps-disconnect-client">disconnecting</a> the call</li>
  <li>Otherwise, make a request to the telephony system to remove the call
  participant from the multiparty call.</li>
  </ol></p>
  
  <p>The <code>split</code> method when invoked MUST run the following steps:
  <ol><li>If the provided remote party identifier (phone number) is not a member 
  of the current call, raise an <code>ILLEGAL_STATE</code> exception</li>
  <li>Otherwise, if the call is not a multiparty call, return gracefully and do
  not modify the current call</li>
  <li>Otherwise, make a request to the telephony system to remove the call
  participant from the multiparty call.</li>
  </ol></p>
  </section> <!-- telephony-steps -->
      
</section> <!-- TelephonyCall -->


<!----------------------- Interface CallHistoryEntry ------------------------->
<section class="informative">
  <h2><a>CallHistoryEntry</a> Interface</h2>
  <p>This interface describes the properties which MUST be supported for call
  history entries.</p>
  
  <dl title="[NoInterfaceObject]
    interface CallHistoryEntry"
    class="idl">
    <dt>readonly attribute DOMString[] participants</dt>
    <dd>It MUST return the array of remote party identifiers (telephone numbers)
    of the call participants, excluding that of the caller.</dd>
    
    <dt>readonly attribute DOMString serviceId</dt>
    <dd>It MUST return the <a>telephony service id</a> of the 
    <a>telephony service </a> used for the call.</dd>
    
    <dt>readonly attribute Date startTime</dt>
    <dd>The starting time of the call, measured from when the call is in
    <code>"connected"</code> state.</dd>
    
    <dt>readonly attribute double duration</dt>
    <dd>The duration of the call in seconds.</dd>
    
    <dt>readonly attribute DOMString direction</dt>
    <dd>The direction of the call. The following values MUST be supported:<ol>
      <li><code>"dialed"</code>: for dialed calls</li>
      <li><code>"received"</code>: for received calls</li>
      <li><code>"missed"</code>: for missed calls</li>
      <li><code>"missed-new"</code>: for missed calls not seen yet by the user.
      </li></ol></dd>
  </dl>
</section> <!-- CallHistoryEntry -->

 
<section>
<h2>Acknowledgements</h2>
<p>The editors would like to express their gratitude to the Mozilla B2G Team for
their technical guidance, implementation work and support.</p>
</section>

</body>
</html>
